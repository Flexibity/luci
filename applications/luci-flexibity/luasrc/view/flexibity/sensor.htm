<%#
LuCI - Lua Configuration Interface
Copyright 2008-2009 Steven Barth <steven@midlink.org>
Copyright 2008-2011 Jo-Philipp Wich <xm@subsignal.org>
Copyright 2012 Maxim Osipov <maxim.osipov@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0
-%>

<%+header%>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript" src="<%=resource%>/smoothie.js"></script>

<h2><a id="content" name="content"><%:Measurements%></a></h2>

<div class="cbi-map" id="sensors">
</div>

<script type="text/javascript">//<![CDATA[
	<%local path = luci.dispatcher.context.requestpath%>
	<%local addr = path[#path]:gsub(":", "z")%>
	var addr = <%luci.http.write_json(addr)%>
	var smoothie = new Object;
	var line = new Object;
	// Get data descriptor
	XHR.get('<%=luci.dispatcher.build_url("admin", "services", "sensors_poll", addr, "desc")%>', null,
		function(x, st) {
			if (st) {
				document.getElementById('sensors').innerHTML = "";
				for (var i in st.data) {
					var str = '<h2>' + i + ' (' + st.data[i] + ')</h2>';
					str += '<fieldset class="cbi-section">';
					str += '<canvas id="plot_' + i + '" width="400" height="80"></canvas>';
					str += '<font size="80" color="red" id="val_' + i + '">...</font>';
					str += '<font size="80" color="red">' + st.data[i] + '</font>';
					str += '</fieldset>';
					document.getElementById('sensors').innerHTML += str;
					smoothie[i] = new SmoothieChart({
						minValue: 20, maxValue: 30,
						grid: { strokeStyle:'rgb(125, 0, 0)', fillStyle:'rgb(60, 0, 0)',
							lineWidth: 1, millisPerLine: 250, verticalSections: 6, },
						labels: { fillStyle:'rgb(60, 0, 0)' }
					});
					smoothie[i].streamTo(document.getElementById("plot_" + i), 2000);
					line[i] = new TimeSeries({ strokeStyle:'rgb(0, 255, 0)', fillStyle:'rgba(0, 255, 0, 0.4)', lineWidth:3 });
					smoothie[i].addTimeSeries(line[i]);
				}
			}
		}
	);
	// Actually add data
	XHR.poll(1, '<%=luci.dispatcher.build_url("admin", "services", "sensors_poll", addr, "data")%>', null,
		function(x, st) {
			if (st) {
				for (var i in st) {
					line[i].append(new Date().getTime(), st[i]);
					document.getElementById("val_" + i).innerHTML = String.format('%s ', st[i]);
				}
			}
		}
	);
//]]></script>

<%+footer%>

